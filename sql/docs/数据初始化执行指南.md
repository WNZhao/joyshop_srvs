# 数据初始化执行指南

## 概述
本指南说明如何初始化JoyShop微服务系统的完整测试数据，包含3500个商品及其相关的库存、订单、用户等数据。

## 数据规模总览

| 数据类型 | 数量 | 说明 |
|---------|------|------|
| 商品数据 | 3,500个 | 覆盖8大品类，60+品牌 |
| 库存数据 | 3,500条 | 每个商品对应库存记录 |
| 分类关联 | 10,500条 | 商品与分类的多对多关系 |
| 订单数据 | 800个 | 包含2,420个订单商品记录 |
| 用户数据 | 15个 | 测试用户，含管理员 |
| 购物车数据 | 30条 | 9个用户的购物车商品 |
| 品牌数据 | 60+ | 知名品牌信息 |
| 分类数据 | 50+ | 三级分类体系 |

## 执行步骤

### 1. 准备数据库环境
```bash
# 启动MySQL服务
# 确保MySQL 5.7+ 或 8.0+

# 登录MySQL
mysql -u root -p
```

### 2. 创建数据库和表结构
```sql
-- 执行数据库创建脚本
source init/create_databases.sql;

-- 切换到相应数据库并创建表结构
-- (根据你的微服务配置执行相应的初始化脚本)
source init/user_srv_init.sql;
source init/goods_srv_init.sql;  
source init/inventory_srv_init.sql;
source init/order_srv_init.sql;
```

### 3. 按顺序导入数据

**重要：必须按照以下顺序执行，因为存在外键依赖关系**

```sql
-- 1. 用户数据 (基础数据)
source schemas/01_users.sql;

-- 2. 分类数据 (基础数据)
source schemas/02_categories.sql;

-- 3. 品牌数据 (基础数据)  
source schemas/03_brands.sql;

-- 4. 商品数据 (3500个商品，依赖品牌)
source schemas/04_goods.sql;

-- 5. 库存数据 (3500条记录，依赖商品)
source schemas/05_inventory.sql;

-- 6. 购物车数据 (依赖用户和商品)
source schemas/06_shopping_cart.sql;

-- 7. 订单数据 (800个订单，依赖用户和商品)
source schemas/07_orders.sql;

-- 8. 轮播图数据 (基础数据)
source schemas/08_banners.sql;
```

### 4. 数据完整性验证
```sql
-- 执行完整性检查
source scripts/validate_data_integrity.sql;

-- 检查结果，确保没有 ✗ 标记的错误
-- 所有检查项应该显示 ✓ 表示通过
```

## 预计执行时间

| 步骤 | 预计时间 | 说明 |
|------|---------|------|
| 数据库准备 | 1-2分钟 | 创建数据库和表 |
| 基础数据导入 | 1分钟 | 用户、分类、品牌 |
| 商品数据导入 | 2-3分钟 | 3500个商品及分类关联 |
| 库存数据导入 | 1分钟 | 3500条库存记录 |
| 订单数据导入 | 1-2分钟 | 800个订单 |
| 验证检查 | 1分钟 | 完整性验证 |
| **总计** | **7-10分钟** | 取决于硬件性能 |

## 验证要点

### 数据量验证
```sql
-- 检查各表记录数
SELECT 'goods' as table_name, COUNT(*) as count FROM goods
UNION ALL SELECT 'inventory', COUNT(*) FROM inventory  
UNION ALL SELECT 'order_info', COUNT(*) FROM order_info
UNION ALL SELECT 'order_goods', COUNT(*) FROM order_goods;
```

### 关联关系验证
```sql
-- 检查商品库存一致性 
SELECT '商品库存覆盖率' as check_type,
       (SELECT COUNT(*) FROM goods) as goods_count,
       (SELECT COUNT(*) FROM inventory) as inventory_count;

-- 检查订单商品ID范围
SELECT '订单商品ID范围' as check_type,
       MIN(goods_id) as min_id, 
       MAX(goods_id) as max_id 
FROM order_goods;
```

## 性能优化建议

### 推荐索引
```sql
-- 商品表索引
ALTER TABLE goods ADD INDEX idx_brand_id (brand_id);
ALTER TABLE goods ADD INDEX idx_on_sale_status (on_sale, status);

-- 库存表索引  
ALTER TABLE inventory ADD INDEX idx_goods_id (goods_id);

-- 订单表索引
ALTER TABLE order_info ADD INDEX idx_user_status (user_id, status);
ALTER TABLE order_goods ADD INDEX idx_order_goods (order_id, goods_id);

-- 分类关联索引
ALTER TABLE goods_category ADD INDEX idx_category_goods (category_id, goods_id);
```

### 查询优化
```sql
-- 分页查询示例
SELECT * FROM goods WHERE on_sale = true AND status = 1 
ORDER BY created_at DESC LIMIT 20 OFFSET 0;

-- 分类商品查询
SELECT g.* FROM goods g 
JOIN goods_category gc ON g.id = gc.goods_id 
WHERE gc.category_id = 111 AND g.on_sale = true 
LIMIT 20;
```

## 数据特点说明

### 占位符使用
- **商品图片**: `placeholder_image_N.jpg`
- **品牌Logo**: `placeholder_logo_brand.png`  
- **用户头像**: `placeholder_avatar_user`
- 便于后期批量替换为真实图片URL

### 数据分布
- **热门商品**(ID 1-500): 高库存、高价格
- **普通商品**(ID 501-2000): 中等库存、中等价格  
- **长尾商品**(ID 2001-3500): 低库存、低价格

### 业务场景覆盖
- 多种订单状态(待付款、已完成、已取消等)
- 不同用户角色(管理员、普通用户)
- 完整购物流程(商品→购物车→订单)
- 多级分类体系验证

## 故障排除

### 常见问题
1. **外键约束错误**: 检查执行顺序，先导入被引用表
2. **重复键错误**: 清空表后重新导入
3. **执行超时**: 增加MySQL超时设置

### 重置数据
```sql
-- 清空所有数据重新开始
SET FOREIGN_KEY_CHECKS = 0;
TRUNCATE TABLE order_goods;
TRUNCATE TABLE order_info;  
TRUNCATE TABLE shopping_cart;
TRUNCATE TABLE inventory;
TRUNCATE TABLE goods_category;
TRUNCATE TABLE goods;
TRUNCATE TABLE banner;
TRUNCATE TABLE users;
SET FOREIGN_KEY_CHECKS = 1;
```

## 后续扩展

- 可继续扩展到5000-10000个商品
- 添加商品评论和评分数据
- 增加促销活动和优惠券数据
- 集成真实图片资源
- 添加更多测试场景数据